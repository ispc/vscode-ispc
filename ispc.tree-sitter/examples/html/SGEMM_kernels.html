
<!doctype HTML>
<head>
  <title>Tree-sitter Highlighting</title>
  <style>
    body {
      font-family: monospace
    }
    .line-number {
      user-select: none;
      text-align: right;
      color: rgba(27,31,35,.3);
      padding: 0 10px;
    }
    .line {
      white-space: pre;
    }
  </style>
</head>
<body>

<table>
<tr><td class=line-number>1</td><td class=line><span style='font-style: italic;color: #8a8a8a'>/*</span>
</td></tr>
<tr><td class=line-number>2</td><td class=line><span style='font-style: italic;color: #8a8a8a'>  Copyright (c) 2018-2023, Intel Corporation</span>
</td></tr>
<tr><td class=line-number>3</td><td class=line><span style='font-style: italic;color: #8a8a8a'></span>
</td></tr>
<tr><td class=line-number>4</td><td class=line><span style='font-style: italic;color: #8a8a8a'>  SPDX-License-Identifier: BSD-3-Clause</span>
</td></tr>
<tr><td class=line-number>5</td><td class=line><span style='font-style: italic;color: #8a8a8a'>*/</span>
</td></tr>
<tr><td class=line-number>6</td><td class=line>
</td></tr>
<tr><td class=line-number>7</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Various ISPC SGEMM kernel and task/kernel implementations</span>
</td></tr>
<tr><td class=line-number>8</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Junkins, September 2018</span>
</td></tr>
<tr><td class=line-number>9</td><td class=line>
</td></tr>
<tr><td class=line-number>10</td><td class=line>#define <span style='color: #875f00'>TILE_SIZE</span> 32
</td></tr>
<tr><td class=line-number>11</td><td class=line>
</td></tr>
<tr><td class=line-number>12</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #005fd7'>SGEMM_get_program_count</span>() {
</td></tr>
<tr><td class=line-number>13</td><td class=line>    <span style='color: #5f00d7'>return</span> programCount;
</td></tr>
<tr><td class=line-number>14</td><td class=line>}
</td></tr>
<tr><td class=line-number>15</td><td class=line>
</td></tr>
<tr><td class=line-number>16</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #005fd7'>SGEMM_get_tile_size</span>() {
</td></tr>
<tr><td class=line-number>17</td><td class=line>    <span style='color: #5f00d7'>return</span> <span style='color: #875f00'>TILE_SIZE</span>;
</td></tr>
<tr><td class=line-number>18</td><td class=line>}
</td></tr>
<tr><td class=line-number>19</td><td class=line>
</td></tr>
<tr><td class=line-number>20</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Naive implementation. The outer foreach achieves some parallelism.</span>
</td></tr>
<tr><td class=line-number>21</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_naive</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>22</td><td class=line>                        <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>23</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n, k;
</td></tr>
<tr><td class=line-number>24</td><td class=line>    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> aValue, bValue, sum;
</td></tr>
<tr><td class=line-number>25</td><td class=line>
</td></tr>
<tr><td class=line-number>26</td><td class=line>    foreach (m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>M</span>) {
</td></tr>
<tr><td class=line-number>27</td><td class=line>        for (k <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>28</td><td class=line>            sum <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>29</td><td class=line>            for (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>30</td><td class=line>                #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>31</td><td class=line>                aValue <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>32</td><td class=line>                bValue <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k];
</td></tr>
<tr><td class=line-number>33</td><td class=line>                sum <span style='font-weight: bold;color: #4e4e4e'>+=</span>  aValue <span style='font-weight: bold;color: #4e4e4e'>*</span> bValue;
</td></tr>
<tr><td class=line-number>34</td><td class=line>            }
</td></tr>
<tr><td class=line-number>35</td><td class=line>
</td></tr>
<tr><td class=line-number>36</td><td class=line>            #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>37</td><td class=line>            matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k] <span style='font-weight: bold;color: #4e4e4e'>=</span> sum;
</td></tr>
<tr><td class=line-number>38</td><td class=line>        }
</td></tr>
<tr><td class=line-number>39</td><td class=line>    }
</td></tr>
<tr><td class=line-number>40</td><td class=line>}
</td></tr>
<tr><td class=line-number>41</td><td class=line>
</td></tr>
<tr><td class=line-number>42</td><td class=line>
</td></tr>
<tr><td class=line-number>43</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Naive implementation with task parallelism added. The matrix rows are divided into chunks</span>
</td></tr>
<tr><td class=line-number>44</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// which are calculated by separate tasks.</span>
</td></tr>
<tr><td class=line-number>45</td><td class=line><span style='color: #005f5f'>static</span> <span style='color: #5f00d7'>task</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_naive_task</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>46</td><td class=line>                                    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>47</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Determine workset for this task instance:</span>
</td></tr>
<tr><td class=line-number>48</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / taskCount;
</td></tr>
<tr><td class=line-number>49</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowStart       <span style='font-weight: bold;color: #4e4e4e'>=</span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>*</span> taskIndex;
</td></tr>
<tr><td class=line-number>50</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowEnd         <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>+</span> uNumRowsPerTask;
</td></tr>
<tr><td class=line-number>51</td><td class=line>
</td></tr>
<tr><td class=line-number>52</td><td class=line>    foreach (m <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>...</span> uRowEnd) {
</td></tr>
<tr><td class=line-number>53</td><td class=line>        <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n, k;
</td></tr>
<tr><td class=line-number>54</td><td class=line>        <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> sum;
</td></tr>
<tr><td class=line-number>55</td><td class=line>
</td></tr>
<tr><td class=line-number>56</td><td class=line>        for (k <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>57</td><td class=line>            sum <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>58</td><td class=line>            for (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>59</td><td class=line>                #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>60</td><td class=line>                sum <span style='font-weight: bold;color: #4e4e4e'>+=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n] <span style='font-weight: bold;color: #4e4e4e'>*</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k];
</td></tr>
<tr><td class=line-number>61</td><td class=line>            }
</td></tr>
<tr><td class=line-number>62</td><td class=line>            #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>63</td><td class=line>            matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k] <span style='font-weight: bold;color: #4e4e4e'>=</span> sum;
</td></tr>
<tr><td class=line-number>64</td><td class=line>        }
</td></tr>
<tr><td class=line-number>65</td><td class=line>    }
</td></tr>
<tr><td class=line-number>66</td><td class=line>}
</td></tr>
<tr><td class=line-number>67</td><td class=line>
</td></tr>
<tr><td class=line-number>68</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_naive_withTasks</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matC[],
</td></tr>
<tr><td class=line-number>69</td><td class=line>                                    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>70</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// The algorithm divides rows in matrix C (M size) between tasks.</span>
</td></tr>
<tr><td class=line-number>71</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// We want each task to process programCount rows in C matrix to maximize SIMD usage.</span>
</td></tr>
<tr><td class=line-number>72</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> numTasks <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / programCount;
</td></tr>
<tr><td class=line-number>73</td><td class=line>    <span style='color: #5f00d7'>launch</span>[numTasks] <span style='color: #005fd7'>SGEMM_naive_task</span>(matA, matB, matC, <span style='color: #875f00'>M</span>, <span style='color: #875f00'>N</span>, <span style='color: #875f00'>K</span>);
</td></tr>
<tr><td class=line-number>74</td><td class=line>}
</td></tr>
<tr><td class=line-number>75</td><td class=line>
</td></tr>
<tr><td class=line-number>76</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Single task version:</span>
</td></tr>
<tr><td class=line-number>77</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// The optimization added here is use of a tile to reuse the loaded matrix value.</span>
</td></tr>
<tr><td class=line-number>78</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// A SIMD width of tile values are stored and re-used using the shuffle intrinsic.</span>
</td></tr>
<tr><td class=line-number>79</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileShuffle</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>80</td><td class=line>                                            <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>81</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> m, n, nn;
</td></tr>
<tr><td class=line-number>82</td><td class=line>    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileOfA, aValue, sum;
</td></tr>
<tr><td class=line-number>83</td><td class=line>
</td></tr>
<tr><td class=line-number>84</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Launch SPMD control flow.</span>
</td></tr>
<tr><td class=line-number>85</td><td class=line>    foreach (k <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>86</td><td class=line>        for (m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>M</span>; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>87</td><td class=line>            sum <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>88</td><td class=line>            for (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>+=</span>programCount) {
</td></tr>
<tr><td class=line-number>89</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// A SIMD width&#39;s tile of A values...to be re-used.</span>
</td></tr>
<tr><td class=line-number>90</td><td class=line>                tileOfA <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n <span style='font-weight: bold;color: #4e4e4e'>+</span> programIndex];
</td></tr>
<tr><td class=line-number>91</td><td class=line>
</td></tr>
<tr><td class=line-number>92</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// Each program instance will tile multiply, rather naive scalar multiply</span>
</td></tr>
<tr><td class=line-number>93</td><td class=line>                for (nn <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; nn <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> programCount; nn<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>94</td><td class=line>                    aValue <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #005fd7'>shuffle</span>(tileOfA, nn);
</td></tr>
<tr><td class=line-number>95</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Re-use tile values, by shuffling them.</span>
</td></tr>
<tr><td class=line-number>96</td><td class=line>                    sum <span style='font-weight: bold;color: #4e4e4e'>+=</span>  aValue <span style='font-weight: bold;color: #4e4e4e'>*</span> matrixB[(n<span style='font-weight: bold;color: #4e4e4e'>+</span>nn)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k];
</td></tr>
<tr><td class=line-number>97</td><td class=line>                }
</td></tr>
<tr><td class=line-number>98</td><td class=line>            }
</td></tr>
<tr><td class=line-number>99</td><td class=line>            matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k] <span style='font-weight: bold;color: #4e4e4e'>=</span> sum;
</td></tr>
<tr><td class=line-number>100</td><td class=line>        }
</td></tr>
<tr><td class=line-number>101</td><td class=line>    }
</td></tr>
<tr><td class=line-number>102</td><td class=line>}
</td></tr>
<tr><td class=line-number>103</td><td class=line>
</td></tr>
<tr><td class=line-number>104</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Multiple task version of the above:</span>
</td></tr>
<tr><td class=line-number>105</td><td class=line><span style='color: #005f5f'>static</span> <span style='color: #5f00d7'>task</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileShuffle_task</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>106</td><td class=line>                                            <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>107</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Determine workset for this task instance:</span>
</td></tr>
<tr><td class=line-number>108</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uNumColsPerTask    <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>K</span> / taskCount;
</td></tr>
<tr><td class=line-number>109</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uColStart          <span style='font-weight: bold;color: #4e4e4e'>=</span> uNumColsPerTask <span style='font-weight: bold;color: #4e4e4e'>*</span> taskIndex;
</td></tr>
<tr><td class=line-number>110</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uColEnd            <span style='font-weight: bold;color: #4e4e4e'>=</span> uColStart <span style='font-weight: bold;color: #4e4e4e'>+</span> uNumColsPerTask;
</td></tr>
<tr><td class=line-number>111</td><td class=line>
</td></tr>
<tr><td class=line-number>112</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> m, n, nn;
</td></tr>
<tr><td class=line-number>113</td><td class=line>    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileOfA, aValue, sum;
</td></tr>
<tr><td class=line-number>114</td><td class=line>
</td></tr>
<tr><td class=line-number>115</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Now launch SPMD control flow over columns.</span>
</td></tr>
<tr><td class=line-number>116</td><td class=line>    foreach (k <span style='font-weight: bold;color: #4e4e4e'>=</span> uColStart <span style='font-weight: bold;color: #4e4e4e'>...</span> uColEnd) {
</td></tr>
<tr><td class=line-number>117</td><td class=line>        for (m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>M</span>; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>118</td><td class=line>            sum <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>119</td><td class=line>            for (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>+=</span>programCount) {
</td></tr>
<tr><td class=line-number>120</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// A SIMD width&#39;s tile of A values...to be re-used.</span>
</td></tr>
<tr><td class=line-number>121</td><td class=line>                tileOfA <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n <span style='font-weight: bold;color: #4e4e4e'>+</span> programIndex];
</td></tr>
<tr><td class=line-number>122</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// Each program instance will tile multiply.</span>
</td></tr>
<tr><td class=line-number>123</td><td class=line>                for (nn <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; nn <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> programCount; nn<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>124</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Re-use tile values, by shuffling them.</span>
</td></tr>
<tr><td class=line-number>125</td><td class=line>                    aValue <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #005fd7'>shuffle</span>(tileOfA, nn);
</td></tr>
<tr><td class=line-number>126</td><td class=line>                    sum <span style='font-weight: bold;color: #4e4e4e'>+=</span>  aValue <span style='font-weight: bold;color: #4e4e4e'>*</span> matrixB[(n<span style='font-weight: bold;color: #4e4e4e'>+</span>nn)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k];
</td></tr>
<tr><td class=line-number>127</td><td class=line>                }
</td></tr>
<tr><td class=line-number>128</td><td class=line>            }
</td></tr>
<tr><td class=line-number>129</td><td class=line>            matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k] <span style='font-weight: bold;color: #4e4e4e'>=</span> sum;
</td></tr>
<tr><td class=line-number>130</td><td class=line>        }
</td></tr>
<tr><td class=line-number>131</td><td class=line>    }
</td></tr>
<tr><td class=line-number>132</td><td class=line>}
</td></tr>
<tr><td class=line-number>133</td><td class=line>
</td></tr>
<tr><td class=line-number>134</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileShuffle_withTasks</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matC[],
</td></tr>
<tr><td class=line-number>135</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>136</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// The algorithm divides columns in matrix C (K size) between tasks.</span>
</td></tr>
<tr><td class=line-number>137</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// We want each task to process programCount colums in C matrix to maximize SIMD usage.</span>
</td></tr>
<tr><td class=line-number>138</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> numTasks <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>K</span> / programCount;
</td></tr>
<tr><td class=line-number>139</td><td class=line>    <span style='color: #5f00d7'>launch</span>[numTasks] <span style='color: #005fd7'>SGEMM_tileShuffle_task</span>(matA, matB, matC, <span style='color: #875f00'>M</span>, <span style='color: #875f00'>N</span>, <span style='color: #875f00'>K</span>);
</td></tr>
<tr><td class=line-number>140</td><td class=line> }
</td></tr>
<tr><td class=line-number>141</td><td class=line>
</td></tr>
<tr><td class=line-number>142</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Single task version:</span>
</td></tr>
<tr><td class=line-number>143</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// This version uses reduce_add(). This allows reduction across program instances.</span>
</td></tr>
<tr><td class=line-number>144</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// This allows re-use of stored tile without shuffle.</span>
</td></tr>
<tr><td class=line-number>145</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileReduceAdd</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>146</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>147</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> m, k, k0;
</td></tr>
<tr><td class=line-number>148</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_SIZE</span>];
</td></tr>
<tr><td class=line-number>149</td><td class=line>    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileOfA;
</td></tr>
<tr><td class=line-number>150</td><td class=line>
</td></tr>
<tr><td class=line-number>151</td><td class=line>    for (m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>M</span>; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>152</td><td class=line>        for (k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0<span style='font-weight: bold;color: #4e4e4e'>+=</span><span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>153</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>154</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>155</td><td class=line>                sumTile[ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>156</td><td class=line>            }
</td></tr>
<tr><td class=line-number>157</td><td class=line>
</td></tr>
<tr><td class=line-number>158</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;vertically&quot; over the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>159</td><td class=line>            foreach (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>N</span>) {
</td></tr>
<tr><td class=line-number>160</td><td class=line>                tileOfA <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>161</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; kt <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_SIZE</span>; kt<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>162</td><td class=line>                    #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>163</td><td class=line>                    sumTile[kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #005fd7'>reduce_add</span>(tileOfA <span style='font-weight: bold;color: #4e4e4e'>*</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt]);
</td></tr>
<tr><td class=line-number>164</td><td class=line>                }
</td></tr>
<tr><td class=line-number>165</td><td class=line>            }
</td></tr>
<tr><td class=line-number>166</td><td class=line>
</td></tr>
<tr><td class=line-number>167</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>168</td><td class=line>            foreach(ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>169</td><td class=line>                matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[ki];
</td></tr>
<tr><td class=line-number>170</td><td class=line>            }
</td></tr>
<tr><td class=line-number>171</td><td class=line>        }
</td></tr>
<tr><td class=line-number>172</td><td class=line>    }
</td></tr>
<tr><td class=line-number>173</td><td class=line>}
</td></tr>
<tr><td class=line-number>174</td><td class=line>
</td></tr>
<tr><td class=line-number>175</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Multiple task version of the above:</span>
</td></tr>
<tr><td class=line-number>176</td><td class=line><span style='color: #005f5f'>static</span> <span style='color: #5f00d7'>task</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileReduceAdd_task</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>177</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>178</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Determine workset for this task instance:</span>
</td></tr>
<tr><td class=line-number>179</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / taskCount;
</td></tr>
<tr><td class=line-number>180</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>=</span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>*</span> taskIndex;
</td></tr>
<tr><td class=line-number>181</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowEnd <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>+</span> uNumRowsPerTask;
</td></tr>
<tr><td class=line-number>182</td><td class=line>
</td></tr>
<tr><td class=line-number>183</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> m, k, k0;
</td></tr>
<tr><td class=line-number>184</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_SIZE</span>];
</td></tr>
<tr><td class=line-number>185</td><td class=line>    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileOfA;
</td></tr>
<tr><td class=line-number>186</td><td class=line>
</td></tr>
<tr><td class=line-number>187</td><td class=line>    for(m <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> uRowEnd; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>188</td><td class=line>        for (k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>189</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>190</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>191</td><td class=line>                sumTile[ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>192</td><td class=line>            }
</td></tr>
<tr><td class=line-number>193</td><td class=line>
</td></tr>
<tr><td class=line-number>194</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;vertically&quot; over the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>195</td><td class=line>            foreach (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>N</span>) {
</td></tr>
<tr><td class=line-number>196</td><td class=line>                tileOfA <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>197</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; kt <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_SIZE</span>; kt<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>198</td><td class=line>                    #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>199</td><td class=line>                    sumTile[kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #005fd7'>reduce_add</span>(tileOfA <span style='font-weight: bold;color: #4e4e4e'>*</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt]);
</td></tr>
<tr><td class=line-number>200</td><td class=line>                }
</td></tr>
<tr><td class=line-number>201</td><td class=line>            }
</td></tr>
<tr><td class=line-number>202</td><td class=line>
</td></tr>
<tr><td class=line-number>203</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>204</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>205</td><td class=line>                matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[ki];
</td></tr>
<tr><td class=line-number>206</td><td class=line>            }
</td></tr>
<tr><td class=line-number>207</td><td class=line>        }
</td></tr>
<tr><td class=line-number>208</td><td class=line>    }
</td></tr>
<tr><td class=line-number>209</td><td class=line>}
</td></tr>
<tr><td class=line-number>210</td><td class=line>
</td></tr>
<tr><td class=line-number>211</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileReduceAdd_withTasks</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matC[],
</td></tr>
<tr><td class=line-number>212</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>213</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// The algorithm divides rows in matrix C (M size) between tasks.</span>
</td></tr>
<tr><td class=line-number>214</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// We want each task to process programCount rows in C matrix to maximize SIMD usage.</span>
</td></tr>
<tr><td class=line-number>215</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> numTasks <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / programCount;
</td></tr>
<tr><td class=line-number>216</td><td class=line>    <span style='color: #5f00d7'>launch</span>[numTasks] <span style='color: #005fd7'>SGEMM_tileReduceAdd_task</span>(matA, matB, matC, <span style='color: #875f00'>M</span>, <span style='color: #875f00'>N</span>, <span style='color: #875f00'>K</span>);
</td></tr>
<tr><td class=line-number>217</td><td class=line>}
</td></tr>
<tr><td class=line-number>218</td><td class=line>
</td></tr>
<tr><td class=line-number>219</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// This version uses atomic_add_local() to perform addition.</span>
</td></tr>
<tr><td class=line-number>220</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// This causes the version to be significantly slower due to the bottleneck here.</span>
</td></tr>
<tr><td class=line-number>221</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileAtomicAdd</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>222</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>223</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> m, k, k0;
</td></tr>
<tr><td class=line-number>224</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_SIZE</span>];
</td></tr>
<tr><td class=line-number>225</td><td class=line>    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileOfA;
</td></tr>
<tr><td class=line-number>226</td><td class=line>
</td></tr>
<tr><td class=line-number>227</td><td class=line>    for (m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>M</span>; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>228</td><td class=line>        for (k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>229</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>230</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>231</td><td class=line>                sumTile[ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>232</td><td class=line>            }
</td></tr>
<tr><td class=line-number>233</td><td class=line>
</td></tr>
<tr><td class=line-number>234</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;vertically&quot; over the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>235</td><td class=line>            foreach (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>N</span>) {
</td></tr>
<tr><td class=line-number>236</td><td class=line>                tileOfA <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>237</td><td class=line>
</td></tr>
<tr><td class=line-number>238</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; kt <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_SIZE</span>; kt<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>239</td><td class=line>
</td></tr>
<tr><td class=line-number>240</td><td class=line>                    #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>241</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileProd <span style='font-weight: bold;color: #4e4e4e'>=</span> tileOfA <span style='font-weight: bold;color: #4e4e4e'>*</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>242</td><td class=line>                    <span style='color: #005fd7'>atomic_add_local</span>(<span style='font-weight: bold;color: #4e4e4e'>&amp;</span>sumTile[kt], tileProd);
</td></tr>
<tr><td class=line-number>243</td><td class=line>                }
</td></tr>
<tr><td class=line-number>244</td><td class=line>            }
</td></tr>
<tr><td class=line-number>245</td><td class=line>
</td></tr>
<tr><td class=line-number>246</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>247</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>248</td><td class=line>                matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[ki];
</td></tr>
<tr><td class=line-number>249</td><td class=line>            }
</td></tr>
<tr><td class=line-number>250</td><td class=line>        }
</td></tr>
<tr><td class=line-number>251</td><td class=line>    }
</td></tr>
<tr><td class=line-number>252</td><td class=line>}
</td></tr>
<tr><td class=line-number>253</td><td class=line>
</td></tr>
<tr><td class=line-number>254</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Multiple task version of the above:</span>
</td></tr>
<tr><td class=line-number>255</td><td class=line><span style='color: #5f00d7'>task</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileAtomicAdd_task</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>256</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>257</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Determine workset for this task instance:</span>
</td></tr>
<tr><td class=line-number>258</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / taskCount;
</td></tr>
<tr><td class=line-number>259</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>=</span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>*</span> taskIndex;
</td></tr>
<tr><td class=line-number>260</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowEnd <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>+</span> uNumRowsPerTask;
</td></tr>
<tr><td class=line-number>261</td><td class=line>
</td></tr>
<tr><td class=line-number>262</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> m, k, k0;
</td></tr>
<tr><td class=line-number>263</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_SIZE</span>];
</td></tr>
<tr><td class=line-number>264</td><td class=line>    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileOfA;
</td></tr>
<tr><td class=line-number>265</td><td class=line>
</td></tr>
<tr><td class=line-number>266</td><td class=line>    for (m <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> uRowEnd; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>267</td><td class=line>        for (k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>268</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>269</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>270</td><td class=line>                sumTile[ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>271</td><td class=line>            }
</td></tr>
<tr><td class=line-number>272</td><td class=line>
</td></tr>
<tr><td class=line-number>273</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;vertically&quot; over the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>274</td><td class=line>            foreach (n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>N</span>) {
</td></tr>
<tr><td class=line-number>275</td><td class=line>                tileOfA <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>276</td><td class=line>
</td></tr>
<tr><td class=line-number>277</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; kt <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_SIZE</span>; kt<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>278</td><td class=line>                    #pragma ignore warning(perf)
</td></tr>
<tr><td class=line-number>279</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> tileProd <span style='font-weight: bold;color: #4e4e4e'>=</span> tileOfA <span style='font-weight: bold;color: #4e4e4e'>*</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>280</td><td class=line>                    <span style='color: #005fd7'>atomic_add_local</span>(<span style='font-weight: bold;color: #4e4e4e'>&amp;</span>sumTile[kt], tileProd);
</td></tr>
<tr><td class=line-number>281</td><td class=line>                }
</td></tr>
<tr><td class=line-number>282</td><td class=line>            }
</td></tr>
<tr><td class=line-number>283</td><td class=line>
</td></tr>
<tr><td class=line-number>284</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>285</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>286</td><td class=line>                matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[ki];
</td></tr>
<tr><td class=line-number>287</td><td class=line>            }
</td></tr>
<tr><td class=line-number>288</td><td class=line>        }
</td></tr>
<tr><td class=line-number>289</td><td class=line>    }
</td></tr>
<tr><td class=line-number>290</td><td class=line>}
</td></tr>
<tr><td class=line-number>291</td><td class=line>
</td></tr>
<tr><td class=line-number>292</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileAtomicAdd_withTasks</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matC[],
</td></tr>
<tr><td class=line-number>293</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>294</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// The algorithm divides rows in matrix C (M size) between tasks.</span>
</td></tr>
<tr><td class=line-number>295</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// We want each task to process programCount rows in C matrix to maximize SIMD usage.</span>
</td></tr>
<tr><td class=line-number>296</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> numTasks <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / programCount;
</td></tr>
<tr><td class=line-number>297</td><td class=line>    <span style='color: #5f00d7'>launch</span>[numTasks] <span style='color: #005fd7'>SGEMM_tileAtomicAdd_task</span>(matA, matB, matC, <span style='color: #875f00'>M</span>, <span style='color: #875f00'>N</span>, <span style='color: #875f00'>K</span>);
</td></tr>
<tr><td class=line-number>298</td><td class=line>}
</td></tr>
<tr><td class=line-number>299</td><td class=line>
</td></tr>
<tr><td class=line-number>300</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// This SGEMM_tileNoSIMDIntrin() code is (much!) faster than above implementations for serveral reasons:</span>
</td></tr>
<tr><td class=line-number>301</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// 1) Every memory fetch and store to MatrixA, MatrixB, and MatrixC is achieved w/o general gather or scatter.</span>
</td></tr>
<tr><td class=line-number>302</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//    This is because ISPC allows repeatedly changing the &quot;axis of SPMD parallelism&quot; (e.g. multiple foreach()</span>
</td></tr>
<tr><td class=line-number>303</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//    loops, or even nesting a foreach() loop within a conventional for() loop.  Thus the compiler easily knows</span>
</td></tr>
<tr><td class=line-number>304</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//    what loop iteration variable is used to index memory, and since adjacent it can easily block load adjacent</span>
</td></tr>
<tr><td class=line-number>305</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//    elements in memory.</span>
</td></tr>
<tr><td class=line-number>306</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// 2) No atomics or horizonal intrinsics were used in this operation.</span>
</td></tr>
<tr><td class=line-number>307</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// 3) The code caches a wide sumTile[] of read/write values for re-use,</span>
</td></tr>
<tr><td class=line-number>308</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//    presumably &quot;locally&quot; in multiple SIMD registers.  Importantly, b.c the compiler knows the single threaded</span>
</td></tr>
<tr><td class=line-number>309</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//    foundation of the ISPC SPMD programmming model, it is easy for it to enable register allocation of such</span>
</td></tr>
<tr><td class=line-number>310</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//    tiled data.</span>
</td></tr>
<tr><td class=line-number>311</td><td class=line><span style='font-style: italic;color: #8a8a8a'>//</span>
</td></tr>
<tr><td class=line-number>312</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// But most importantly, this code is simple to undestand, debug, and easy to maintain.</span>
</td></tr>
<tr><td class=line-number>313</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileNoSIMDIntrin</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>314</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>315</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_SIZE</span>], oneAVal;
</td></tr>
<tr><td class=line-number>316</td><td class=line>
</td></tr>
<tr><td class=line-number>317</td><td class=line>    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>M</span>; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>318</td><td class=line>        for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>319</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>320</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>321</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// No scatter required.</span>
</td></tr>
<tr><td class=line-number>322</td><td class=line>                sumTile[ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>323</td><td class=line>            }
</td></tr>
<tr><td class=line-number>324</td><td class=line>
</td></tr>
<tr><td class=line-number>325</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// Loop over the the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>326</td><td class=line>            for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>327</td><td class=line>                oneAVal <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>328</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// SPMD iterate over the TILE dimension, but within for loop nest:</span>
</td></tr>
<tr><td class=line-number>329</td><td class=line>                foreach (kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>330</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Note, no gather required.</span>
</td></tr>
<tr><td class=line-number>331</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> matB  <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>332</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Pure SIMD FMAC:</span>
</td></tr>
<tr><td class=line-number>333</td><td class=line>                    sumTile[kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal <span style='font-weight: bold;color: #4e4e4e'>*</span> matB;
</td></tr>
<tr><td class=line-number>334</td><td class=line>                }
</td></tr>
<tr><td class=line-number>335</td><td class=line>            }
</td></tr>
<tr><td class=line-number>336</td><td class=line>
</td></tr>
<tr><td class=line-number>337</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>338</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>339</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// Note, no scatter required.</span>
</td></tr>
<tr><td class=line-number>340</td><td class=line>                matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[ki];
</td></tr>
<tr><td class=line-number>341</td><td class=line>            }
</td></tr>
<tr><td class=line-number>342</td><td class=line>        }
</td></tr>
<tr><td class=line-number>343</td><td class=line>    }
</td></tr>
<tr><td class=line-number>344</td><td class=line>}
</td></tr>
<tr><td class=line-number>345</td><td class=line>
</td></tr>
<tr><td class=line-number>346</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Multiple task version of the above:</span>
</td></tr>
<tr><td class=line-number>347</td><td class=line><span style='color: #005f5f'>static</span> <span style='color: #5f00d7'>task</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileNoSIMDIntrin_task</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>348</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>349</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Determine workset for this task instance:</span>
</td></tr>
<tr><td class=line-number>350</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / taskCount;
</td></tr>
<tr><td class=line-number>351</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>=</span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>*</span> taskIndex;
</td></tr>
<tr><td class=line-number>352</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowEnd <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>+</span> uNumRowsPerTask;
</td></tr>
<tr><td class=line-number>353</td><td class=line>
</td></tr>
<tr><td class=line-number>354</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_SIZE</span>], oneAVal;
</td></tr>
<tr><td class=line-number>355</td><td class=line>
</td></tr>
<tr><td class=line-number>356</td><td class=line>    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> m <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> uRowEnd; m<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>357</td><td class=line>        for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>358</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>359</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>360</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// No scatter required.</span>
</td></tr>
<tr><td class=line-number>361</td><td class=line>                sumTile[ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>362</td><td class=line>            }
</td></tr>
<tr><td class=line-number>363</td><td class=line>
</td></tr>
<tr><td class=line-number>364</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// Loop over the the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>365</td><td class=line>            for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>366</td><td class=line>                oneAVal <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>367</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// SPMD iterate over the TILE dimension, but within for loop nest:</span>
</td></tr>
<tr><td class=line-number>368</td><td class=line>                foreach (kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>369</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Note, no gather required.</span>
</td></tr>
<tr><td class=line-number>370</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> matB <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>371</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Pure SIMD FMAC;</span>
</td></tr>
<tr><td class=line-number>372</td><td class=line>                    sumTile[kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal <span style='font-weight: bold;color: #4e4e4e'>*</span> matB;
</td></tr>
<tr><td class=line-number>373</td><td class=line>                }
</td></tr>
<tr><td class=line-number>374</td><td class=line>            }
</td></tr>
<tr><td class=line-number>375</td><td class=line>
</td></tr>
<tr><td class=line-number>376</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>377</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_SIZE</span>) {
</td></tr>
<tr><td class=line-number>378</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// Note, no scatter required.</span>
</td></tr>
<tr><td class=line-number>379</td><td class=line>                matrixC[m<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[ki];
</td></tr>
<tr><td class=line-number>380</td><td class=line>            }
</td></tr>
<tr><td class=line-number>381</td><td class=line>        }
</td></tr>
<tr><td class=line-number>382</td><td class=line>    }
</td></tr>
<tr><td class=line-number>383</td><td class=line>}
</td></tr>
<tr><td class=line-number>384</td><td class=line>
</td></tr>
<tr><td class=line-number>385</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileNoSIMDIntrin_withTasks</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matC[],
</td></tr>
<tr><td class=line-number>386</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>387</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// The algorithm divides rows in matrix C (M size) between tasks.</span>
</td></tr>
<tr><td class=line-number>388</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// We want each task to process programCount rows in C matrix to maximize SIMD usage.</span>
</td></tr>
<tr><td class=line-number>389</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> numTasks <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / programCount;
</td></tr>
<tr><td class=line-number>390</td><td class=line>    <span style='color: #5f00d7'>launch</span>[numTasks] <span style='color: #005fd7'>SGEMM_tileNoSIMDIntrin_task</span>(matA, matB, matC, <span style='color: #875f00'>M</span>, <span style='color: #875f00'>N</span>, <span style='color: #875f00'>K</span>);
</td></tr>
<tr><td class=line-number>391</td><td class=line>}
</td></tr>
<tr><td class=line-number>392</td><td class=line>
</td></tr>
<tr><td class=line-number>393</td><td class=line>
</td></tr>
<tr><td class=line-number>394</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// This version is modified version of &#39;SGEMM_tileNoSIMDIntrin&#39;.</span>
</td></tr>
<tr><td class=line-number>395</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// The tile used to read/write values for re-use is a 2D block of height 2 instead of a n array of same width.</span>
</td></tr>
<tr><td class=line-number>396</td><td class=line>#define <span style='color: #875f00'>TILE_HEIGHT</span> 2
</td></tr>
<tr><td class=line-number>397</td><td class=line>#define <span style='color: #875f00'>TILE_WIDTH</span> 32
</td></tr>
<tr><td class=line-number>398</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>399</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>400</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_HEIGHT</span>][<span style='color: #875f00'>TILE_WIDTH</span>];
</td></tr>
<tr><td class=line-number>401</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> oneAVal[<span style='color: #875f00'>TILE_HEIGHT</span>];
</td></tr>
<tr><td class=line-number>402</td><td class=line>
</td></tr>
<tr><td class=line-number>403</td><td class=line>    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>M</span>; m <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_HEIGHT</span>) {
</td></tr>
<tr><td class=line-number>404</td><td class=line>        for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>405</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension.</span>
</td></tr>
<tr><td class=line-number>406</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>407</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_HEIGHT</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>408</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// No scatter required.</span>
</td></tr>
<tr><td class=line-number>409</td><td class=line>                    sumTile[i][ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>410</td><td class=line>                }
</td></tr>
<tr><td class=line-number>411</td><td class=line>            }
</td></tr>
<tr><td class=line-number>412</td><td class=line>
</td></tr>
<tr><td class=line-number>413</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// Loop over the the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>414</td><td class=line>            for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>415</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_HEIGHT</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>)
</td></tr>
<tr><td class=line-number>416</td><td class=line>                    oneAVal[i] <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[(m <span style='font-weight: bold;color: #4e4e4e'>+</span> i)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>417</td><td class=line>
</td></tr>
<tr><td class=line-number>418</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// SPMD iterate over the TILE dimension, but within for loop nest:</span>
</td></tr>
<tr><td class=line-number>419</td><td class=line>                foreach (kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>420</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Note, no gather required.</span>
</td></tr>
<tr><td class=line-number>421</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> matB1 <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>422</td><td class=line>                    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_HEIGHT</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>423</td><td class=line>                        <span style='font-style: italic;color: #8a8a8a'>// Pure SIMD FMAC:</span>
</td></tr>
<tr><td class=line-number>424</td><td class=line>                        sumTile[i][kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal[i] <span style='font-weight: bold;color: #4e4e4e'>*</span> matB1;
</td></tr>
<tr><td class=line-number>425</td><td class=line>                    }
</td></tr>
<tr><td class=line-number>426</td><td class=line>                }
</td></tr>
<tr><td class=line-number>427</td><td class=line>            }
</td></tr>
<tr><td class=line-number>428</td><td class=line>
</td></tr>
<tr><td class=line-number>429</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>430</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>431</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='font-weight: bold;color: #875f00'>2</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>432</td><td class=line>                    matrixC[(m <span style='font-weight: bold;color: #4e4e4e'>+</span> i)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[i][ki];
</td></tr>
<tr><td class=line-number>433</td><td class=line>                }
</td></tr>
<tr><td class=line-number>434</td><td class=line>
</td></tr>
<tr><td class=line-number>435</td><td class=line>            }
</td></tr>
<tr><td class=line-number>436</td><td class=line>        }
</td></tr>
<tr><td class=line-number>437</td><td class=line>    }
</td></tr>
<tr><td class=line-number>438</td><td class=line>}
</td></tr>
<tr><td class=line-number>439</td><td class=line>
</td></tr>
<tr><td class=line-number>440</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Multiple task version of the above:</span>
</td></tr>
<tr><td class=line-number>441</td><td class=line><span style='color: #5f00d7'>task</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin_task</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>442</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>443</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_HEIGHT</span>][<span style='color: #875f00'>TILE_WIDTH</span>];
</td></tr>
<tr><td class=line-number>444</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> oneAVal[<span style='color: #875f00'>TILE_HEIGHT</span>];
</td></tr>
<tr><td class=line-number>445</td><td class=line>
</td></tr>
<tr><td class=line-number>446</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Determine workset for this task instance:</span>
</td></tr>
<tr><td class=line-number>447</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / taskCount;
</td></tr>
<tr><td class=line-number>448</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>=</span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>*</span> taskIndex;
</td></tr>
<tr><td class=line-number>449</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowEnd <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>+</span> uNumRowsPerTask;
</td></tr>
<tr><td class=line-number>450</td><td class=line>
</td></tr>
<tr><td class=line-number>451</td><td class=line>    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> m <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> uRowEnd; m <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_HEIGHT</span>) {
</td></tr>
<tr><td class=line-number>452</td><td class=line>        for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>453</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension.</span>
</td></tr>
<tr><td class=line-number>454</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>455</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_HEIGHT</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>456</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// No scatter required.</span>
</td></tr>
<tr><td class=line-number>457</td><td class=line>                    sumTile[i][ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>458</td><td class=line>                }
</td></tr>
<tr><td class=line-number>459</td><td class=line>            }
</td></tr>
<tr><td class=line-number>460</td><td class=line>
</td></tr>
<tr><td class=line-number>461</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// Loop over the the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>462</td><td class=line>            for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>463</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_HEIGHT</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>)
</td></tr>
<tr><td class=line-number>464</td><td class=line>                    oneAVal[i] <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[(m <span style='font-weight: bold;color: #4e4e4e'>+</span> i)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n];
</td></tr>
<tr><td class=line-number>465</td><td class=line>
</td></tr>
<tr><td class=line-number>466</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// SPMD iterate over the TILE dimension, but within for loop nest:</span>
</td></tr>
<tr><td class=line-number>467</td><td class=line>                foreach (kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>468</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Note, no gather required.</span>
</td></tr>
<tr><td class=line-number>469</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> matB1 <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixB[n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>470</td><td class=line>                    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>TILE_HEIGHT</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>471</td><td class=line>                        <span style='font-style: italic;color: #8a8a8a'>// Pure SIMD FMAC:</span>
</td></tr>
<tr><td class=line-number>472</td><td class=line>                        sumTile[i][kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal[i] <span style='font-weight: bold;color: #4e4e4e'>*</span> matB1;
</td></tr>
<tr><td class=line-number>473</td><td class=line>                    }
</td></tr>
<tr><td class=line-number>474</td><td class=line>                }
</td></tr>
<tr><td class=line-number>475</td><td class=line>            }
</td></tr>
<tr><td class=line-number>476</td><td class=line>
</td></tr>
<tr><td class=line-number>477</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>478</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>479</td><td class=line>                for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> i <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; i <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='font-weight: bold;color: #875f00'>2</span>; i<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>480</td><td class=line>                    matrixC[(m <span style='font-weight: bold;color: #4e4e4e'>+</span> i)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[i][ki];
</td></tr>
<tr><td class=line-number>481</td><td class=line>                }
</td></tr>
<tr><td class=line-number>482</td><td class=line>
</td></tr>
<tr><td class=line-number>483</td><td class=line>            }
</td></tr>
<tr><td class=line-number>484</td><td class=line>        }
</td></tr>
<tr><td class=line-number>485</td><td class=line>    }
</td></tr>
<tr><td class=line-number>486</td><td class=line>}
</td></tr>
<tr><td class=line-number>487</td><td class=line>
</td></tr>
<tr><td class=line-number>488</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin_withTasks</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matC[],
</td></tr>
<tr><td class=line-number>489</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>490</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// The algorithm divides rows in matrix C (M size) between tasks.</span>
</td></tr>
<tr><td class=line-number>491</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// We want each task to process programCount rows in C matrix to maximize SIMD usage.</span>
</td></tr>
<tr><td class=line-number>492</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> numTasks <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / programCount;
</td></tr>
<tr><td class=line-number>493</td><td class=line>    <span style='color: #5f00d7'>launch</span>[numTasks] <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin_task</span>(matA, matB, matC, <span style='color: #875f00'>M</span>, <span style='color: #875f00'>N</span>, <span style='color: #875f00'>K</span>);
</td></tr>
<tr><td class=line-number>494</td><td class=line>}
</td></tr>
<tr><td class=line-number>495</td><td class=line>
</td></tr>
<tr><td class=line-number>496</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// This version is a further modified version of &#39;SGEMM_tileBlockNoSIMDIntrin&#39;.</span>
</td></tr>
<tr><td class=line-number>497</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Since we already know the tile height, the loop used to access the tile vertically is replaced.</span>
</td></tr>
<tr><td class=line-number>498</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin_2</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>499</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>500</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_HEIGHT</span>][<span style='color: #875f00'>TILE_WIDTH</span>];
</td></tr>
<tr><td class=line-number>501</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> oneAVal[<span style='color: #875f00'>TILE_HEIGHT</span>];
</td></tr>
<tr><td class=line-number>502</td><td class=line>
</td></tr>
<tr><td class=line-number>503</td><td class=line>    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> m <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>M</span>; m <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_HEIGHT</span>) {
</td></tr>
<tr><td class=line-number>504</td><td class=line>        for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>505</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension.</span>
</td></tr>
<tr><td class=line-number>506</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>507</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// No scatter required.</span>
</td></tr>
<tr><td class=line-number>508</td><td class=line>                sumTile[<span style='font-weight: bold;color: #875f00'>0</span>][ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>509</td><td class=line>                sumTile[<span style='font-weight: bold;color: #875f00'>1</span>][ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>510</td><td class=line>            }
</td></tr>
<tr><td class=line-number>511</td><td class=line>
</td></tr>
<tr><td class=line-number>512</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// Loop over the the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>513</td><td class=line>            for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>514</td><td class=line>                <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mTimesNPlusN <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>0</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n;
</td></tr>
<tr><td class=line-number>515</td><td class=line>                <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mPlusOneTimesNPlusN <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>1</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n;
</td></tr>
<tr><td class=line-number>516</td><td class=line>                <span style='color: #005fd7'>prefetch_nt</span>(<span style='font-weight: bold;color: #4e4e4e'>&amp;</span>matrixA[mPlusOneTimesNPlusN]);
</td></tr>
<tr><td class=line-number>517</td><td class=line>                <span style='color: #005fd7'>prefetch_nt</span>(<span style='font-weight: bold;color: #4e4e4e'>&amp;</span>matrixA[mTimesNPlusN]);
</td></tr>
<tr><td class=line-number>518</td><td class=line>
</td></tr>
<tr><td class=line-number>519</td><td class=line>                oneAVal[<span style='font-weight: bold;color: #875f00'>0</span>] <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[mTimesNPlusN];
</td></tr>
<tr><td class=line-number>520</td><td class=line>                oneAVal[<span style='font-weight: bold;color: #875f00'>1</span>] <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[mPlusOneTimesNPlusN];
</td></tr>
<tr><td class=line-number>521</td><td class=line>
</td></tr>
<tr><td class=line-number>522</td><td class=line>                <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> nTimesKPlusk0 <span style='font-weight: bold;color: #4e4e4e'>=</span> n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0;
</td></tr>
<tr><td class=line-number>523</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// SPMD iterate over the TILE dimension, but within for loop nest:</span>
</td></tr>
<tr><td class=line-number>524</td><td class=line>                foreach (kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>525</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Note, no gather required.</span>
</td></tr>
<tr><td class=line-number>526</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> matB1 <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixB[nTimesKPlusk0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>527</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Pure SIMD FMAC:</span>
</td></tr>
<tr><td class=line-number>528</td><td class=line>                    sumTile[<span style='font-weight: bold;color: #875f00'>0</span>][kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal[<span style='font-weight: bold;color: #875f00'>0</span>] <span style='font-weight: bold;color: #4e4e4e'>*</span> matB1;
</td></tr>
<tr><td class=line-number>529</td><td class=line>                    sumTile[<span style='font-weight: bold;color: #875f00'>1</span>][kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal[<span style='font-weight: bold;color: #875f00'>1</span>] <span style='font-weight: bold;color: #4e4e4e'>*</span> matB1;
</td></tr>
<tr><td class=line-number>530</td><td class=line>                }
</td></tr>
<tr><td class=line-number>531</td><td class=line>            }
</td></tr>
<tr><td class=line-number>532</td><td class=line>            <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>0</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0;
</td></tr>
<tr><td class=line-number>533</td><td class=line>            <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mPlusOneTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>1</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0;
</td></tr>
<tr><td class=line-number>534</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>535</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>536</td><td class=line>                matrixC[mTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[<span style='font-weight: bold;color: #875f00'>0</span>][ki];
</td></tr>
<tr><td class=line-number>537</td><td class=line>                matrixC[mPlusOneTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[<span style='font-weight: bold;color: #875f00'>1</span>][ki];
</td></tr>
<tr><td class=line-number>538</td><td class=line>            }
</td></tr>
<tr><td class=line-number>539</td><td class=line>        }
</td></tr>
<tr><td class=line-number>540</td><td class=line>    }
</td></tr>
<tr><td class=line-number>541</td><td class=line>}
</td></tr>
<tr><td class=line-number>542</td><td class=line>
</td></tr>
<tr><td class=line-number>543</td><td class=line><span style='font-style: italic;color: #8a8a8a'>// Multiple task version of the above:</span>
</td></tr>
<tr><td class=line-number>544</td><td class=line><span style='color: #5f00d7'>task</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin_2_task</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matrixC[],
</td></tr>
<tr><td class=line-number>545</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>546</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> sumTile[<span style='color: #875f00'>TILE_HEIGHT</span>][<span style='color: #875f00'>TILE_WIDTH</span>];
</td></tr>
<tr><td class=line-number>547</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> oneAVal[<span style='color: #875f00'>TILE_HEIGHT</span>];
</td></tr>
<tr><td class=line-number>548</td><td class=line>
</td></tr>
<tr><td class=line-number>549</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// Determine workset for this task instance:</span>
</td></tr>
<tr><td class=line-number>550</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / taskCount;
</td></tr>
<tr><td class=line-number>551</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>=</span> uNumRowsPerTask <span style='font-weight: bold;color: #4e4e4e'>*</span> taskIndex;
</td></tr>
<tr><td class=line-number>552</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> uRowEnd <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart <span style='font-weight: bold;color: #4e4e4e'>+</span> uNumRowsPerTask;
</td></tr>
<tr><td class=line-number>553</td><td class=line>
</td></tr>
<tr><td class=line-number>554</td><td class=line>    for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> m <span style='font-weight: bold;color: #4e4e4e'>=</span> uRowStart; m <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> uRowEnd; m <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_HEIGHT</span>) {
</td></tr>
<tr><td class=line-number>555</td><td class=line>        for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> k0 <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>K</span>; k0 <span style='font-weight: bold;color: #4e4e4e'>+=</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>556</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>557</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>558</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// No scatter required.</span>
</td></tr>
<tr><td class=line-number>559</td><td class=line>                sumTile[<span style='font-weight: bold;color: #875f00'>0</span>][ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>560</td><td class=line>                sumTile[<span style='font-weight: bold;color: #875f00'>1</span>][ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0.0f</span>;
</td></tr>
<tr><td class=line-number>561</td><td class=line>            }
</td></tr>
<tr><td class=line-number>562</td><td class=line>
</td></tr>
<tr><td class=line-number>563</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// Loop over the the matrix N dimension:</span>
</td></tr>
<tr><td class=line-number>564</td><td class=line>            for (<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> n <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span>; n <span style='font-weight: bold;color: #4e4e4e'>&lt;</span> <span style='color: #875f00'>N</span>; n<span style='font-weight: bold;color: #4e4e4e'>++</span>) {
</td></tr>
<tr><td class=line-number>565</td><td class=line>                <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mTimesNPlusN <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>0</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n;
</td></tr>
<tr><td class=line-number>566</td><td class=line>                <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mPlusOneTimesNPlusN <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>1</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>N</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> n;
</td></tr>
<tr><td class=line-number>567</td><td class=line>                <span style='color: #005fd7'>prefetch_nt</span>(<span style='font-weight: bold;color: #4e4e4e'>&amp;</span>matrixA[mPlusOneTimesNPlusN]);
</td></tr>
<tr><td class=line-number>568</td><td class=line>                <span style='color: #005fd7'>prefetch_nt</span>(<span style='font-weight: bold;color: #4e4e4e'>&amp;</span>matrixA[mTimesNPlusN]);
</td></tr>
<tr><td class=line-number>569</td><td class=line>
</td></tr>
<tr><td class=line-number>570</td><td class=line>                oneAVal[<span style='font-weight: bold;color: #875f00'>0</span>] <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[mTimesNPlusN];
</td></tr>
<tr><td class=line-number>571</td><td class=line>                oneAVal[<span style='font-weight: bold;color: #875f00'>1</span>] <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixA[mPlusOneTimesNPlusN];
</td></tr>
<tr><td class=line-number>572</td><td class=line>
</td></tr>
<tr><td class=line-number>573</td><td class=line>                <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> nTimesKPlusk0 <span style='font-weight: bold;color: #4e4e4e'>=</span> n<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0;
</td></tr>
<tr><td class=line-number>574</td><td class=line>                <span style='font-style: italic;color: #8a8a8a'>// SPMD iterate over the TILE dimension, but within for loop nest:</span>
</td></tr>
<tr><td class=line-number>575</td><td class=line>                foreach (kt <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>576</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Note, no gather required.</span>
</td></tr>
<tr><td class=line-number>577</td><td class=line>                    <span style='color: #005f5f'>varying</span> <span style='color: #005f5f'>float</span> matB1 <span style='font-weight: bold;color: #4e4e4e'>=</span> matrixB[nTimesKPlusk0 <span style='font-weight: bold;color: #4e4e4e'>+</span> kt];
</td></tr>
<tr><td class=line-number>578</td><td class=line>                    <span style='font-style: italic;color: #8a8a8a'>// Pure SIMD FMAC:</span>
</td></tr>
<tr><td class=line-number>579</td><td class=line>                    sumTile[<span style='font-weight: bold;color: #875f00'>0</span>][kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal[<span style='font-weight: bold;color: #875f00'>0</span>] <span style='font-weight: bold;color: #4e4e4e'>*</span> matB1;
</td></tr>
<tr><td class=line-number>580</td><td class=line>                    sumTile[<span style='font-weight: bold;color: #875f00'>1</span>][kt] <span style='font-weight: bold;color: #4e4e4e'>+=</span> oneAVal[<span style='font-weight: bold;color: #875f00'>1</span>] <span style='font-weight: bold;color: #4e4e4e'>*</span> matB1;
</td></tr>
<tr><td class=line-number>581</td><td class=line>                }
</td></tr>
<tr><td class=line-number>582</td><td class=line>            }
</td></tr>
<tr><td class=line-number>583</td><td class=line>            <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>0</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0;
</td></tr>
<tr><td class=line-number>584</td><td class=line>            <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>unsigned <span style='color: #005f5f'>int</span></span> mPlusOneTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>=</span> (m <span style='font-weight: bold;color: #4e4e4e'>+</span> <span style='font-weight: bold;color: #875f00'>1</span>)<span style='font-weight: bold;color: #4e4e4e'>*</span><span style='color: #875f00'>K</span> <span style='font-weight: bold;color: #4e4e4e'>+</span> k0;
</td></tr>
<tr><td class=line-number>585</td><td class=line>            <span style='font-style: italic;color: #8a8a8a'>// SPMD &quot;horizontally&quot; again over TILE dimension:</span>
</td></tr>
<tr><td class=line-number>586</td><td class=line>            foreach (ki <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='font-weight: bold;color: #875f00'>0</span> <span style='font-weight: bold;color: #4e4e4e'>...</span> <span style='color: #875f00'>TILE_WIDTH</span>) {
</td></tr>
<tr><td class=line-number>587</td><td class=line>                matrixC[mTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[<span style='font-weight: bold;color: #875f00'>0</span>][ki];
</td></tr>
<tr><td class=line-number>588</td><td class=line>                matrixC[mPlusOneTimesKPlusK0 <span style='font-weight: bold;color: #4e4e4e'>+</span> ki] <span style='font-weight: bold;color: #4e4e4e'>=</span> sumTile[<span style='font-weight: bold;color: #875f00'>1</span>][ki];
</td></tr>
<tr><td class=line-number>589</td><td class=line>            }
</td></tr>
<tr><td class=line-number>590</td><td class=line>        }
</td></tr>
<tr><td class=line-number>591</td><td class=line>    }
</td></tr>
<tr><td class=line-number>592</td><td class=line>}
</td></tr>
<tr><td class=line-number>593</td><td class=line>
</td></tr>
<tr><td class=line-number>594</td><td class=line><span style='color: #005f5f'>export</span> <span style='color: #005f5f'>void</span> <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin_2_withTasks</span>(<span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matA[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matB[], <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>float</span> matC[],
</td></tr>
<tr><td class=line-number>595</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>M</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>N</span>, <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> <span style='color: #875f00'>K</span>) {
</td></tr>
<tr><td class=line-number>596</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// The algorithm divides rows in matrix C (M size) between tasks.</span>
</td></tr>
<tr><td class=line-number>597</td><td class=line>    <span style='font-style: italic;color: #8a8a8a'>// We want each task to process programCount rows in C matrix to maximize SIMD usage.</span>
</td></tr>
<tr><td class=line-number>598</td><td class=line>    <span style='color: #005f5f'>uniform</span> <span style='color: #005f5f'>int</span> numTasks <span style='font-weight: bold;color: #4e4e4e'>=</span> <span style='color: #875f00'>M</span> / programCount;
</td></tr>
<tr><td class=line-number>599</td><td class=line>    <span style='color: #5f00d7'>launch</span>[numTasks] <span style='color: #005fd7'>SGEMM_tileBlockNoSIMDIntrin_2_task</span>(matA, matB, matC, <span style='color: #875f00'>M</span>, <span style='color: #875f00'>N</span>, <span style='color: #875f00'>K</span>);
</td></tr>
<tr><td class=line-number>600</td><td class=line>}
</td></tr>
</table>

</body>

